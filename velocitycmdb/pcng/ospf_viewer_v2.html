<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSPF Topology Explorer v2</title>
    <script src="https://unpkg.com/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0a0e17;
            color: #e2e8f0;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        /* Left Panel */
        .sidebar {
            width: 280px;
            background: #161b22;
            border-right: 1px solid #30363d;
            padding: 16px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar h2 {
            font-size: 1.1rem;
            color: #58a6ff;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #30363d;
        }

        .sidebar h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #8b949e;
            margin: 16px 0 8px;
        }

        .file-btn {
            width: 100%;
            padding: 12px;
            background: #238636;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .file-btn:hover { background: #2ea043; }

        #fileName {
            font-size: 0.75rem;
            color: #8b949e;
            margin-bottom: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #58a6ff;
        }

        .stat-box .label {
            font-size: 0.65rem;
            color: #8b949e;
            text-transform: uppercase;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .filter-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .filter-btn {
            padding: 4px 8px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #8b949e;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .filter-btn:hover { background: #30363d; color: #fff; }
        .filter-btn.active { background: #238636; border-color: #238636; color: #fff; }

        /* Main Graph */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
            height: 100%;
        }

        .graph-wrapper {
            flex: 1;
            position: relative;
            background: #0d1117;
            min-height: 0;
            height: 100%;
        }

        #mynetwork {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .graph-controls {
            position: absolute;
            bottom: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
        }

        .ctrl-btn {
            width: 36px;
            height: 36px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #8b949e;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ctrl-btn:hover { background: #30363d; color: #fff; }

        /* Right Panel */
        .details {
            width: 350px;
            background: #161b22;
            border-left: 1px solid #30363d;
            padding: 16px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .details h3 {
            font-size: 0.9rem;
            color: #58a6ff;
            margin-bottom: 12px;
        }

        .detail-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-row .label { color: #8b949e; }
        .detail-row .value { color: #e2e8f0; font-family: monospace; }
        .detail-row .value.full { color: #3fb950; }
        .detail-row .value.down { color: #f85149; }

        .peer-item {
            background: #161b22;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .peer-item:hover { background: #21262d; }
        .peer-item .name { font-size: 0.8rem; }
        .peer-item .intf { font-size: 0.7rem; color: #8b949e; font-family: monospace; }
        .peer-item .rid { font-size: 0.65rem; color: #58a6ff; font-family: monospace; }

        .badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .badge.full { background: rgba(63,185,80,0.2); color: #3fb950; }
        .badge.down { background: rgba(248,81,73,0.2); color: #f85149; }
        .badge.warn { background: rgba(210,153,34,0.2); color: #d29922; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .hidden { display: none; }

        .debug-section {
            font-size: 0.7rem;
            color: #8b949e;
            background: #161b22;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            word-break: break-all;
        }

        .warn-text { color: #d29922; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <h2>üîó OSPF Explorer v2</h2>

            <input type="file" id="fileInput" accept=".json" class="hidden">
            <button class="file-btn" onclick="document.getElementById('fileInput').click()">
                üìÇ Load JSON File
            </button>
            <div id="fileName"></div>

            <div class="stats" id="stats">
                <div class="stat-box"><div class="value" id="statDevices">0</div><div class="label">Devices</div></div>
                <div class="stat-box"><div class="value" id="statLinks">0</div><div class="label">Links</div></div>
                <div class="stat-box"><div class="value" id="statAreas">0</div><div class="label">Areas</div></div>
                <div class="stat-box"><div class="value" id="statFull">0%</div><div class="label">Full</div></div>
            </div>

            <h3>Search</h3>
            <input type="text" class="search-box" id="searchBox" placeholder="Filter devices...">

            <h3>Sites</h3>
            <div class="filter-btns" id="siteFilters"></div>

            <h3>Roles</h3>
            <div class="filter-btns" id="roleFilters"></div>

            <h3>State</h3>
            <div class="filter-btns" id="stateFilters">
                <button class="filter-btn active" data-val="all">All</button>
                <button class="filter-btn" data-val="FULL">Full</button>
                <button class="filter-btn" data-val="2-WAY">2-Way</button>
            </div>

            <h3>Options</h3>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem; cursor: pointer;">
                <input type="checkbox" id="hideOrphans" checked style="cursor: pointer;">
                Hide nodes with no peers
            </label>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem; cursor: pointer; margin-top: 8px;">
                <input type="checkbox" id="showUnmapped" style="cursor: pointer;">
                Highlight unmapped RIDs
            </label>
        </aside>

        <!-- Main Graph -->
        <main class="main">
            <div class="graph-wrapper">
                <div id="mynetwork"></div>
                <div class="graph-controls">
                    <button class="ctrl-btn" onclick="zoomIn()">+</button>
                    <button class="ctrl-btn" onclick="zoomOut()">‚àí</button>
                    <button class="ctrl-btn" onclick="fitAll()">‚ä°</button>
                    <button class="ctrl-btn" onclick="togglePhysics()">‚ö°</button>
                </div>
            </div>
        </main>

        <!-- Right Details Panel -->
        <aside class="details">
            <div id="detailPanel">
                <div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 16px;">üñ±Ô∏è</div>
                    <p>Click a node or link<br>to view details</p>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Globals
        let data = null;
        let network = null;
        let nodes = null;
        let edges = null;
        let physicsOn = true;

        // Colors
        const roleColors = {
            edge: '#f0883e', peer: '#a371f7', aggregation: '#58a6ff',
            spine: '#3fb950', tor: '#79c0ff', oob: '#8b949e',
            leaf: '#56d364', core: '#ff7b72', unknown: '#484f58'
        };

        // File load
        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = evt => {
                try {
                    data = JSON.parse(evt.target.result);
                    console.log('Loaded data:', data);
                    console.log('Metadata:', data.metadata);
                    init();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsText(file);
        });

        function init() {
            updateStats();
            buildFilters();
            buildGraph();
        }

        function updateStats() {
            document.getElementById('statDevices').textContent = data.nodes?.length || 0;
            document.getElementById('statLinks').textContent = data.links?.length || 0;
            document.getElementById('statAreas').textContent = Object.keys(data.areas || {}).length;

            const full = (data.links || []).filter(l => l.state === 'FULL').length;
            const pct = data.links?.length ? Math.round(100 * full / data.links.length) : 0;
            document.getElementById('statFull').textContent = pct + '%';
        }

        function buildFilters() {
            // Sites
            const sites = [...new Set((data.nodes || []).map(n => n.site))].filter(Boolean).filter(s => s !== 'unknown');
            const siteDiv = document.getElementById('siteFilters');
            siteDiv.innerHTML = '<button class="filter-btn active" data-val="all">All</button>';
            sites.forEach(s => {
                siteDiv.innerHTML += `<button class="filter-btn" data-val="${s}">${s}</button>`;
            });

            // Roles
            const roles = [...new Set((data.nodes || []).map(n => n.role))].filter(Boolean).filter(r => r !== 'unknown');
            const roleDiv = document.getElementById('roleFilters');
            roleDiv.innerHTML = '<button class="filter-btn active" data-val="all">All</button>';
            roles.forEach(r => {
                roleDiv.innerHTML += `<button class="filter-btn" data-val="${r}">${r}</button>`;
            });

            // Click handlers - multi-select for sites and roles, single for state
            document.getElementById('siteFilters').addEventListener('click', e => {
                if (!e.target.classList.contains('filter-btn')) return;
                const val = e.target.dataset.val;
                const container = e.target.parentElement;

                if (val === 'all') {
                    // "All" clears others and activates itself
                    container.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                } else {
                    // Toggle this button
                    e.target.classList.toggle('active');
                    // Deactivate "All" if any specific is selected
                    const allBtn = container.querySelector('[data-val="all"]');
                    const anySpecific = container.querySelectorAll('.filter-btn.active:not([data-val="all"])').length > 0;
                    if (anySpecific) {
                        allBtn.classList.remove('active');
                    } else {
                        // If nothing selected, reactivate "All"
                        allBtn.classList.add('active');
                    }
                }
                applyFilters();
            });

            document.getElementById('roleFilters').addEventListener('click', e => {
                if (!e.target.classList.contains('filter-btn')) return;
                const val = e.target.dataset.val;
                const container = e.target.parentElement;

                if (val === 'all') {
                    container.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                } else {
                    e.target.classList.toggle('active');
                    const allBtn = container.querySelector('[data-val="all"]');
                    const anySpecific = container.querySelectorAll('.filter-btn.active:not([data-val="all"])').length > 0;
                    if (anySpecific) {
                        allBtn.classList.remove('active');
                    } else {
                        allBtn.classList.add('active');
                    }
                }
                applyFilters();
            });

            // State filter stays single-select
            document.getElementById('stateFilters').addEventListener('click', e => {
                if (e.target.classList.contains('filter-btn')) {
                    e.target.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    applyFilters();
                }
            });
        }

        function buildGraph() {
            const container = document.getElementById('mynetwork');
            console.log('Building graph, container size:', container.offsetWidth, container.offsetHeight);

            // Build nodes array
            const nodesArray = (data.nodes || []).map(n => ({
                id: n.id,
                label: n.id,
                title: `${n.id}\n${n.platform || ''}\nRouter ID: ${n.router_id || ''}\nNeighbor Count: ${n.neighbor_count || 0}`,
                color: {
                    background: n.is_unmapped ? '#d29922' : (roleColors[n.role] || '#484f58'),
                    border: n.has_data ? '#ffffff' : '#484f58'
                },
                borderWidth: n.has_data ? 2 : 1,
                font: { color: '#e2e8f0', size: 12 },
                shape: 'box',
                margin: 10,
                _raw: n
            }));

            console.log('Nodes array:', nodesArray.length);

            // Build edges array
            const edgesArray = (data.links || []).map((l, i) => ({
                id: l.id || `edge_${i}`,
                from: l.source,
                to: l.target,
                label: l.source_interface || '',
                title: `${l.source_interface || '?'} ‚Üî ${l.target_interface || '?'}\nArea: ${l.area}\nState: ${l.state}\nBidirectional: ${l.bidirectional !== false ? 'Yes' : 'No'}`,
                color: l.state === 'FULL' ? '#3fb950' : l.state === '2-WAY' ? '#d29922' : '#f85149',
                width: l.state === 'FULL' ? 2 : 1,
                dashes: l.state !== 'FULL' || l.bidirectional === false,
                font: { color: '#8b949e', size: 10 },
                _raw: l
            }));

            console.log('Edges array:', edgesArray.length);

            nodes = new vis.DataSet(nodesArray);
            edges = new vis.DataSet(edgesArray);

            const graphData = { nodes: nodes, edges: edges };

            const options = {
                physics: {
                    enabled: true,
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -80,
                        springLength: 200,
                        springConstant: 0.05
                    },
                    stabilization: { iterations: 150 }
                },
                interaction: { hover: true, tooltipDelay: 50 },
                nodes: { shadow: true },
                edges: { smooth: { type: 'continuous' } }
            };

            network = new vis.Network(container, graphData, options);
            console.log('Network created');

            network.on('click', params => {
                if (params.nodes.length > 0) {
                    const node = nodes.get(params.nodes[0]);
                    showNodeDetails(node._raw);
                } else if (params.edges.length > 0) {
                    const edge = edges.get(params.edges[0]);
                    showLinkDetails(edge._raw);
                }
            });

            network.once('stabilizationIterationsDone', () => {
                console.log('Stabilization complete');
            });

            setTimeout(() => {
                console.log('Forcing fit and redraw');
                applyFilters();
                network.fit();
                network.redraw();

                const canvas = container.querySelector('canvas');
                console.log('Canvas:', canvas, canvas?.width, canvas?.height);

                const positions = network.getPositions();
                console.log('Node positions:', Object.keys(positions).length, positions);
            }, 1000);
        }

        function showNodeDetails(node) {
            // Find links by hostname
            const linksByHostname = (data.links || []).filter(l =>
                l.source === node.id || l.target === node.id
            );

            // Find links by router_id (for cases where RID is used instead of hostname)
            const linksByRid = node.router_id && node.router_id !== node.id ?
                (data.links || []).filter(l =>
                    l.source === node.router_id || l.target === node.router_id
                ) : [];

            // Combine and dedupe
            const allLinks = [...linksByHostname];
            linksByRid.forEach(rl => {
                if (!allLinks.find(l => l.id === rl.id)) {
                    allLinks.push(rl);
                }
            });

            // Helper to get peer's router_id
            const getPeerInfo = (peerId) => {
                const peerNode = (data.nodes || []).find(n => n.id === peerId);
                return {
                    rid: peerNode?.router_id || peerId,
                    hasData: peerNode?.has_data || false,
                    isUnmapped: peerNode?.is_unmapped || false
                };
            };

            // Count how many links are in graph vs what node reports
            const reportedNeighborCount = node.neighbor_count || 0;
            const graphLinkCount = allLinks.length;
            const mismatch = reportedNeighborCount !== graphLinkCount;

            document.getElementById('detailPanel').innerHTML = `
                <div class="detail-card">
                    <h3>üì° ${node.id}</h3>
                    <div class="detail-row">
                        <span class="label">Router ID</span>
                        <span class="value" style="color: #58a6ff;">${node.router_id || '-'}</span>
                    </div>
                    <div class="detail-row"><span class="label">Platform</span><span class="value">${node.platform || '-'}</span></div>
                    <div class="detail-row"><span class="label">Vendor</span><span class="value">${node.vendor || '-'}</span></div>
                    <div class="detail-row"><span class="label">Site</span><span class="value">${node.site || '-'}</span></div>
                    <div class="detail-row"><span class="label">Role</span><span class="value">${node.role || '-'}</span></div>
                    <div class="detail-row"><span class="label">Has Data</span><span class="value">${node.has_data ? '‚úì' : '‚úó'}</span></div>
                    <div class="detail-row">
                        <span class="label">Reported Neighbors</span>
                        <span class="value ${mismatch ? 'warn-text' : ''}">${reportedNeighborCount}</span>
                    </div>
                    ${node.is_unmapped ? '<div class="detail-row"><span class="label">‚ö†Ô∏è Status</span><span class="value down">Unmapped RID</span></div>' : ''}
                </div>

                <div class="detail-card">
                    <h3>üîó Peers in Graph (${allLinks.length}) ${mismatch ? '<span class="warn-text">‚ö†</span>' : ''}</h3>
                    ${allLinks.length === 0 ? '<div style="color: #8b949e; font-size: 0.8rem; padding: 8px;">No peers found in links data</div>' : ''}
                    ${allLinks.map(l => {
                        const isSource = l.source === node.id || l.source === node.router_id;
                        const peer = isSource ? l.target : l.source;
                        const peerInfo = getPeerInfo(peer);
                        const localInt = isSource ? l.source_interface : l.target_interface;
                        const remoteInt = isSource ? l.target_interface : l.source_interface;
                        const isBidir = l.bidirectional !== false;
                        const isTargetUnmapped = l.target_unmapped === true;
                        return `
                            <div class="peer-item" onclick="focusNode('${peer}')">
                                <div style="flex: 1; min-width: 0;">
                                    <div class="name">${peer} ${peerInfo.isUnmapped ? '‚ö†Ô∏è' : ''}</div>
                                    <div class="rid">RID: ${peerInfo.rid}</div>
                                    <div class="intf">${localInt || '?'} ‚Üî ${remoteInt || '?'}</div>
                                </div>
                                <div style="text-align: right; flex-shrink: 0;">
                                    <span class="badge ${l.state === 'FULL' ? 'full' : 'down'}">${l.state}</span>
                                    ${!isBidir ? '<div class="badge warn" style="margin-top: 2px;">1-way</div>' : ''}
                                    ${isTargetUnmapped ? '<div class="badge warn" style="margin-top: 2px;">unmapped</div>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="detail-card">
                    <h3>üîç Debug Info</h3>
                    <div class="detail-row"><span class="label">Links by hostname</span><span class="value">${linksByHostname.length}</span></div>
                    <div class="detail-row"><span class="label">Links by RID</span><span class="value">${linksByRid.length}</span></div>
                    <div class="detail-row"><span class="label">Total unique links</span><span class="value">${allLinks.length}</span></div>
                    <div class="detail-row"><span class="label">Reported neighbors</span><span class="value">${reportedNeighborCount}</span></div>
                    ${mismatch ? `
                        <div class="debug-section" style="color: #d29922;">
                            ‚ö†Ô∏è Mismatch: Node reports ${reportedNeighborCount} neighbors but only ${allLinks.length} links found in graph data.
                            <br><br>
                            Possible causes:
                            <br>‚Ä¢ Router-ID not correlated to hostname
                            <br>‚Ä¢ Link deduplication removed entries
                            <br>‚Ä¢ Missing neighbor data files
                        </div>
                    ` : ''}
                    <div class="debug-section">
                        Searching links for:<br>
                        ‚Ä¢ hostname: "${node.id}"<br>
                        ‚Ä¢ router_id: "${node.router_id || 'N/A'}"
                    </div>
                </div>
            `;
        }

        function showLinkDetails(link) {
            // Get node info for source and target
            const srcNode = (data.nodes || []).find(n => n.id === link.source);
            const tgtNode = (data.nodes || []).find(n => n.id === link.target);

            document.getElementById('detailPanel').innerHTML = `
                <div class="detail-card">
                    <h3>üîó Link</h3>
                    <div class="detail-row"><span class="label">Source</span><span class="value">${link.source}</span></div>
                    <div class="detail-row"><span class="label">Source RID</span><span class="value" style="color: #58a6ff;">${srcNode?.router_id || link.source}</span></div>
                    <div class="detail-row"><span class="label">Source Intf</span><span class="value">${link.source_interface || '-'}</span></div>
                    <hr style="border: none; border-top: 1px solid #30363d; margin: 8px 0;">
                    <div class="detail-row"><span class="label">Target</span><span class="value">${link.target}</span></div>
                    <div class="detail-row"><span class="label">Target RID</span><span class="value" style="color: #58a6ff;">${tgtNode?.router_id || link.target}</span></div>
                    <div class="detail-row"><span class="label">Target Intf</span><span class="value">${link.target_interface || '-'}</span></div>
                </div>
                <div class="detail-card">
                    <h3>üìä OSPF State</h3>
                    <div class="detail-row"><span class="label">State</span><span class="value ${link.state === 'FULL' ? 'full' : 'down'}">${link.state}</span></div>
                    <div class="detail-row"><span class="label">Area</span><span class="value">${link.area || '-'}</span></div>
                    <div class="detail-row"><span class="label">Bidirectional</span><span class="value ${link.bidirectional !== false ? 'full' : 'down'}">${link.bidirectional !== false ? 'Yes' : 'No'}</span></div>
                    <div class="detail-row"><span class="label">Target Unmapped</span><span class="value ${link.target_unmapped ? 'down' : ''}">${link.target_unmapped ? 'Yes' : 'No'}</span></div>
                    <div class="detail-row"><span class="label">DR</span><span class="value">${link.dr || '-'}</span></div>
                    <div class="detail-row"><span class="label">BDR</span><span class="value">${link.bdr || '-'}</span></div>
                    <div class="detail-row"><span class="label">Priority</span><span class="value">${link.source_priority || '-'}</span></div>
                    <div class="detail-row"><span class="label">Adjacency</span><span class="value">${link.adjacency_time || '-'}</span></div>
                    <div class="detail-row"><span class="label">Neighbor IP</span><span class="value">${link.neighbor_address || '-'}</span></div>
                    <div class="detail-row"><span class="label">Options</span><span class="value">${link.options || '-'}</span></div>
                    <div class="detail-row"><span class="label">State Changes</span><span class="value">${link.state_changes || 0}</span></div>
                    <div class="detail-row"><span class="label">LSA Retx</span><span class="value">${link.lsa_retransmit_count || 0}</span></div>
                </div>
                <div class="detail-card">
                    <h3>üîç Debug</h3>
                    <div class="debug-section">
                        Link ID: ${link.id}<br>
                        Source has_data: ${srcNode?.has_data || false}<br>
                        Target has_data: ${tgtNode?.has_data || false}
                    </div>
                </div>
            `;
        }

        function focusNode(id) {
            network.selectNodes([id]);
            network.focus(id, { scale: 1.2, animation: true });
            const node = nodes.get(id);
            if (node) showNodeDetails(node._raw);
        }

        function applyFilters() {
            if (!data || !nodes) return;

            // Get selected sites (multi-select)
            const selectedSites = [...document.querySelectorAll('#siteFilters .filter-btn.active')]
                .map(b => b.dataset.val);
            const allSites = selectedSites.includes('all');

            // Get selected roles (multi-select)
            const selectedRoles = [...document.querySelectorAll('#roleFilters .filter-btn.active')]
                .map(b => b.dataset.val);
            const allRoles = selectedRoles.includes('all');

            const state = document.querySelector('#stateFilters .active')?.dataset.val || 'all';
            const search = document.getElementById('searchBox').value.toLowerCase();
            const hideOrphans = document.getElementById('hideOrphans').checked;

            // Get valid nodes based on state filter
            let validFromState = new Set();
            if (state !== 'all') {
                data.links.filter(l => l.state === state).forEach(l => {
                    validFromState.add(l.source);
                    validFromState.add(l.target);
                });
            }

            // Get nodes that have at least one link
            const nodesWithLinks = new Set();
            data.links.forEach(l => {
                nodesWithLinks.add(l.source);
                nodesWithLinks.add(l.target);
            });

            nodes.forEach(n => {
                const raw = n._raw;
                let show = true;

                if (!allSites && !selectedSites.includes(raw.site)) show = false;
                if (!allRoles && !selectedRoles.includes(raw.role)) show = false;
                if (state !== 'all' && !validFromState.has(n.id)) show = false;
                if (search && !n.id.toLowerCase().includes(search)) show = false;
                if (hideOrphans && !nodesWithLinks.has(n.id)) show = false;

                nodes.update({ id: n.id, hidden: !show });
            });

            edges.forEach(e => {
                const raw = e._raw;
                let show = true;

                if (state !== 'all' && raw.state !== state) show = false;

                const srcNode = nodes.get(e.from);
                const tgtNode = nodes.get(e.to);
                if (srcNode?.hidden || tgtNode?.hidden) show = false;

                edges.update({ id: e.id, hidden: !show });
            });
        }

        document.getElementById('searchBox').addEventListener('input', applyFilters);
        document.getElementById('hideOrphans').addEventListener('change', applyFilters);
        document.getElementById('showUnmapped').addEventListener('change', () => {
            // Could add visual highlighting for unmapped nodes
            applyFilters();
        });

        function zoomIn() { network?.moveTo({ scale: network.getScale() * 1.3, animation: true }); }
        function zoomOut() { network?.moveTo({ scale: network.getScale() / 1.3, animation: true }); }
        function fitAll() { network?.fit({ animation: true }); }
        function togglePhysics() {
            physicsOn = !physicsOn;
            network?.setOptions({ physics: { enabled: physicsOn } });
        }
    </script>
</body>
</html>
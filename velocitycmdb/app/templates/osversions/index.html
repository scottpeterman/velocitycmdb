{% extends "base.html" %}

{% block title %}OS Version Compliance{% endblock %}

{% block content %}
<div style="max-width: 1600px; margin: 0 auto; padding: 24px;">
    <div style="margin-bottom: 32px;">
        <h1 style="display: flex; align-items: center; gap: 16px; margin: 0 0 8px 0; font-size: 32px; font-weight: 400;">
            <i data-lucide="shield-check"></i>
            OS Version Dashboard
        </h1>
        <p style="color: var(--md-on-surface-variant); margin: 0; font-size: 16px;">
            Current OS version distribution across network devices
        </p>
    </div>

    <!-- Summary Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 32px;">
        <div style="background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: 12px; padding: 24px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 56px; height: 56px; background: var(--md-primary-container); color: var(--md-on-primary-container); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i data-lucide="server" size="28"></i>
                </div>
                <div>
                    <div style="font-size: 32px; font-weight: 400; margin: 0;">{{ stats.total_devices }}</div>
                    <div style="color: var(--md-on-surface-variant); font-size: 14px;">Total Devices</div>
                </div>
            </div>
        </div>

        <div style="background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: 12px; padding: 24px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 56px; height: 56px; background: #d4f4dd; color: #0d652d; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i data-lucide="check-circle" size="28"></i>
                </div>
                <div>
                    <div style="font-size: 32px; font-weight: 400; margin: 0;">{{ stats.devices_with_version }}</div>
                    <div style="color: var(--md-on-surface-variant); font-size: 14px;">With Version Data</div>
                </div>
            </div>
        </div>

        <div style="background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: 12px; padding: 24px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 56px; height: 56px; background: var(--md-tertiary-container); color: var(--md-on-tertiary-container); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i data-lucide="layers" size="28"></i>
                </div>
                <div>
                    <div style="font-size: 32px; font-weight: 400; margin: 0;">{{ stats.unique_versions }}</div>
                    <div style="color: var(--md-on-surface-variant); font-size: 14px;">Unique Versions</div>
                </div>
            </div>
        </div>

        <div style="background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: 12px; padding: 24px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 56px; height: 56px; background: #fff4e5; color: #8b5e00; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i data-lucide="percent" size="28"></i>
                </div>
                <div>
                    <div style="font-size: 32px; font-weight: 400; margin: 0;">{{ stats.coverage_pct }}%</div>
                    <div style="color: var(--md-on-surface-variant); font-size: 14px;">Version Coverage</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pie Chart -->
    {% if chart_data %}
    <div style="background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: 12px; margin-bottom: 32px; overflow: hidden;">
        <div style="padding: 24px; border-bottom: 1px solid var(--md-outline-variant);">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 400;">
                <i data-lucide="pie-chart" size="24"></i>
                Top 10 OS Versions by Device Count
            </h2>
        </div>
        <div style="padding: 24px;">
            <canvas id="versionChart" style="max-height: 400px;"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Vendor Summary -->
    <div style="background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: 12px; margin-bottom: 32px; overflow: hidden;">
        <div style="padding: 24px; border-bottom: 1px solid var(--md-outline-variant); display: flex; align-items: center; justify-content: space-between;">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 400;">
                <i data-lucide="factory" size="24"></i>
                Version Distribution by Vendor
            </h2>
            <a href="{{ url_for('osversions.export_csv') }}" class="md-button-outlined" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 24px; border: 1px solid var(--md-outline); border-radius: 20px; text-decoration: none; color: var(--md-primary); font-size: 14px; font-weight: 500;">
                <i data-lucide="download" size="18"></i>
                Export Excel
            </a>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--md-outline-variant); background: var(--md-surface-container);">
                        <th style="text-align: left; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Vendor</th>
                        <th style="text-align: right; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Total Devices</th>
                        <th style="text-align: right; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Unique Versions</th>
                        <th style="text-align: center; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendor in vendor_summary %}
                    <tr style="border-bottom: 1px solid var(--md-outline-variant);">
                        <td style="padding: 16px 24px; font-weight: 500;">{{ vendor.vendor or 'Unknown' }}</td>
                        <td style="padding: 16px 24px; text-align: right;">{{ vendor.total_devices }}</td>
                        <td style="padding: 16px 24px; text-align: right;">{{ vendor.unique_versions }}</td>
                        <td style="padding: 16px 24px; text-align: center;">
                            {% if vendor.vendor %}
                            <a href="{{ url_for('osversions.vendor_detail', vendor_name=vendor.vendor) }}"
                               style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; color: var(--md-primary); text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: 500; transition: background 0.2s;"
                               onmouseover="this.style.background='var(--md-primary-container)'"
                               onmouseout="this.style.background='transparent'">
                                <i data-lucide="eye" size="16"></i>
                                View Details
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Version Details -->
    <div style="background: var(--md-surface); border: 1px solid var(--md-outline-variant); border-radius: 12px; overflow: hidden;">
        <div style="padding: 24px; border-bottom: 1px solid var(--md-outline-variant);">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 400;">
                <i data-lucide="list" size="24"></i>
                All OS Versions ({{ version_distribution|length }})
            </h2>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--md-outline-variant); background: var(--md-surface-container);">
                        <th style="text-align: left; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Vendor</th>
                        <th style="text-align: left; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px; min-width: 300px;">OS Version</th>
                        <th style="text-align: right; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Device Count</th>
                        <th style="text-align: center; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Sites</th>
                        <th style="text-align: left; padding: 16px 24px; font-weight: 500; font-size: 14px; color: var(--md-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">Example Device</th>
                    </tr>
                </thead>
                <tbody>
                    {% for version in version_distribution %}
                    <tr style="border-bottom: 1px solid var(--md-outline-variant);">
                        <td style="padding: 16px 24px; font-weight: 500;">{{ version.vendor or 'Unknown' }}</td>
                        <td style="padding: 16px 24px;">
                            <code style="background: var(--md-surface-container); padding: 4px 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 13px; display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                  title="{{ version.os_version }}">{{ version.os_version }}</code>
                        </td>
                        <td style="padding: 16px 24px; text-align: right; font-weight: 500;">{{ version.device_count }}</td>
                        <td style="padding: 16px 24px; text-align: center;">{{ version.sites.split(',')|length if version.sites else 0 }}</td>
                        <td style="padding: 16px 24px;">
                            {% if version.example_device_id %}
                            <a href="{{ url_for('assets.device_detail', device_id=version.example_device_id) }}"
                               style="color: var(--md-primary); text-decoration: none; font-weight: 500;">
                                {{ version.example_device_name }}
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    lucide.createIcons();

    // Pie Chart for OS Version Distribution
    {% if chart_data %}
    const chartData = {{ chart_data|tojson }};

    if (chartData && chartData.length > 0) {
        const ctx = document.getElementById('versionChart').getContext('2d');

        // Get theme-aware colors from localStorage (persisted theme preference)
        const theme = localStorage.getItem('theme') || 'light';
        let legendColor, borderColor;
        if (theme === 'cyber') {
            legendColor = '#00ccff';  // cyan
            borderColor = '#001019';
        } else if (theme === 'dark') {
            legendColor = '#ffffff';  // white
            borderColor = '#1a1a1a';
        } else {
            legendColor = '#3d2914';  // dark brown
            borderColor = '#ffffff';
        }

        // Generate distinct colors for pie chart
        const colors = [
            'rgba(59, 130, 246, 0.8)',   // Blue
            'rgba(168, 85, 247, 0.8)',   // Purple
            'rgba(16, 185, 129, 0.8)',   // Green
            'rgba(245, 158, 11, 0.8)',   // Orange
            'rgba(239, 68, 68, 0.8)',    // Red
            'rgba(236, 72, 153, 0.8)',   // Pink
            'rgba(14, 165, 233, 0.8)',   // Cyan
            'rgba(132, 204, 22, 0.8)',   // Lime
            'rgba(251, 146, 60, 0.8)',   // Amber
            'rgba(167, 139, 250, 0.8)'   // Violet
        ];

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: chartData.map(d => d.version_label),
                datasets: [{
                    data: chartData.map(d => d.device_count),
                    backgroundColor: colors.slice(0, chartData.length),
                    borderColor: borderColor,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: legendColor,
                            font: {
                                size: 12
                            },
                            padding: 12,
                            boxWidth: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} devices (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
</script>
{% endblock %}